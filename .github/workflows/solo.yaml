# This is a basic workflow to help you get started with Actions

name: solo

# workflow runs whenever a PR against develop is opened or labeled
on:
  pull_request:
    types:
      - labeled
      - opened
    branches: 
      - develop

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  workflow-handler:
    runs-on: ubuntu-22.04
    steps:
    - name: Verification
      uses: actions/github-script@v6.4.0
      with:
        script: |
          const { execSync } = require("child_process");
          console.log("User ${{ github.actor }} opened or labeled a PR. Checking if they are a collaborator...")
          var response = execSync("curl -s -o /dev/null -w \"%{http_code}\" -H \"Accept: application/vnd.github+json\" -H \"Authorization: token ${{ secrets.CWPEARSON_CIDUMMY_METADATAREAD }}\"  -H \"X-GitHub-Api-Version: 2022-11-28\" https://api.github.com/repos/cwpearson/ci-dummy/collaborators/${{ github.actor }}")
          var status_code = response.toString()
          var valid_user = false
          if (status_code == "200") {
            valid_user = true
            console.log("user ${{ github.actor }} has started the workflow")
          }
 
          console.log("${{ github.event.action }}")
          if ("${{ github.event.action }}" === "opened" && valid_user) {
            console.log("Starting job when PR opened by ${{ github.actor }}")
          }
          else if ("${{ github.event.action }}" === "labeled" && "${{ github.event.label.name }}" == "RUN TESTS" && valid_user) {
            console.log("starting job on PR labeled \"${{ github.event.label.name }}\" by ${{ github.actor }}")
          }
          else {
            core.setFailed("not running job: ${{ github.actor }} is not a collaborator")
          }

  configure_build_test:
    needs: workflow-handler
    runs-on: self-hosted

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3

      # Runs a single command using the runners shell
      - name: Run a one-line script
        run: echo Hello, world!

      # Runs a set of commands using the runners shell
      - name: Run a multi-line script
        run: |
          echo Add other actions to build,
          echo test, and deploy your project.
